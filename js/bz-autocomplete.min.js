"use strict";var Autocomplete=function(inpt,options){this.o={};options=options||{};this.inpt=inpt;this.mode="ac";this.ddlmode=false;this.listenInput=true;this.indata=[];this.cache={};this.dataType=null;this.srchString="";for(var k in Autocomplete.defaultOptions){if(Autocomplete.defaultOptions.hasOwnProperty(k)){if(options.hasOwnProperty(k))this.o[k]=options[k];else this.o[k]=Autocomplete.defaultOptions[k]}}if(options.hasOwnProperty("source"))this.o.source=options.source;else this.dataType="ajax";var isFunction=function(functionToCheck){return functionToCheck&&{}.toString.call(functionToCheck)==="[object Function]"};if(this.o.source instanceof Array){if(JSON.stringify(this.o.source).match("{")){this.dataType="array";var tempArr=[],tempData=this.o.source;for(var i=0;i<tempData.length;i++){var arr=Object.values(tempData[i]);tempArr.push(arr)}this.indata=tempArr}else{this.indata=this.o.source}}else if(isFunction(this.o.source)){this.dataType="func"}if(bzDom(inpt).ondata("mode"))this.mode=bzDom(inpt).ondata("mode");if(bzDom(inpt).ondata("ddlmode"))this.ddlmode=bzDom(inpt).ondata("ddlmode");if(!bzDom(inpt).ifattr("autocomplete"))bzDom(inpt).onattr("autocomplete","false");this.init()};Autocomplete.prototype={constructor:Autocomplete,setdata:function(searchstr,$inpt){var ac=this;ac.inpt=$inpt.el;var getData=function(){if(ac.dataType==="func"){if(ac.o.dataurl!==""&&ac.o.dataurl!==null&&ac.o.dataurl!=="undefined"){ac.dataurl=ac.o.dataurl}else if($inpt.ondata("ctr")&&$inpt.ondata("act")){ac.dataurl="/"+$inpt.ondata("ctr")+"/"+$inpt.ondata("act")}else{alert("request url not specified");return null}ac.o.source(ac.passdata,ac.dataurl,searchstr,ac)}else{ac.passdata(ac.o.source,searchstr,ac)}};if(ac.ddlmode==="true"){if("ddl"in ac.cache){ac.indata=ac.cache["ddl"]}else{getData()}ac.selectdata(searchstr)}else if(searchstr.toLowerCase()!==ac.srchString.toLowerCase()){ac.srchString=searchstr;if(searchstr.substring(0,ac.o.searchAfter)in ac.cache){ac.indata=ac.cache[searchstr.substring(0,ac.o.searchAfter)]}else{getData()}ac.selectdata(searchstr)}},passdata:function(data,searchstr,ac){ac.indata=data;if(ac.ddlmode==="true"){ac.cache["ddl"]=ac.indata}else{ac.cache[searchstr]=ac.indata}},checkdata:function(searchstr){var ac=this,tempRes=[];var addnew=false;if(ac.indata.length>0){for(var i=0;i<ac.indata.length;i++){var _data=ac.indata[i];if(typeof _data==="string"){if(ac.ddlmode==="true"){tempRes.push([i+1,_data])}else if(_data.toLowerCase().indexOf(searchstr.toLowerCase())!==-1){tempRes.push([i+1,_data])}else if(ac.mode==="add"||ac.mode==="chip+add"){addnew=true}}else{if(_data[1].toLowerCase().indexOf(searchstr.toLowerCase())!==-1){tempRes.push(_data)}else if(ac.mode==="add"||ac.mode==="chip+add"){addnew=true}}}}else{if(ac.mode==="add"||ac.mode==="chip+add")addnew=true}if(addnew===true&&(ac.mode==="add"||ac.mode==="chip+add")){ac.hidesuggestnew();ac.suggestnew()}return tempRes},selectdata:function(searchstr){var ac=this;var result=ac.checkdata(searchstr);if(ac.indata.length>0){ac.o.suggest(searchstr,result,ac)}},addSuggestions:function(){var ac=this;var $suggestions=bzDom("<ul>");$suggestions.onclass("bz-list-no-style bz-suggestions bz-transition");$suggestions.inhtml("");$suggestions.on("mouseover",function(){var $that=bzDom(this),$inpt=$that.parent(".bz-ac").find("input");$inpt.ondata("hover","1")});$suggestions.on("mouseleave",function(){var $that=bzDom(this),$inpt=$that.parent(".bz-ac").find("input");$inpt.ondata("hover","0")});if(bzDom(ac.inpt).exist()){bzDom(ac.inpt).after($suggestions)}},fillSuggestions:function($listItem){var ac=this;if(bzDom(ac.inpt).parent(".bz-ac").find(".bz-suggestions").exist()){var $suggestions=bzDom(ac.inpt).parent(".bz-ac").find(".bz-suggestions");$suggestions.append($listItem)}},showSuggestions:function(){var ac=this;if(bzDom(ac.inpt).parent(".bz-ac").find(".bz-suggestions").exist()){var $suggestions=bzDom(ac.inpt).parent(".bz-ac").find(".bz-suggestions");$suggestions.offclass("hide")}},hideSuggestions:function(){var ac=this;if(bzDom(ac.inpt).parent(".bz-ac").find(".bz-suggestions").exist()){var $suggestions=bzDom(ac.inpt).parent(".bz-ac").find(".bz-suggestions");if(!$suggestions.ifclass("hide"))$suggestions.onclass("hide")}},removeSuggestions:function(){var ac=this;if(bzDom(ac.inpt).parent(".bz-ac").find(".bz-suggestions").exist()){var $suggestions=bzDom(ac.inpt).parent(".bz-ac").find(".bz-suggestions");$suggestions.remove()}},selection:function(selectionId,selectionName){var ac=this;var $inpt=bzDom(ac.inpt);$inpt.ondata("id",selectionId);$inpt.val(selectionName);if(ac.o.selAction)ac.o.selAction($inpt,selectionId,selectionName,ac);ac.removeSuggestions()},highlightSelection:function($selection,item){var ac=this;var $inpt=bzDom(ac.inpt);var selectionId=$selection.ondata("id");var selectionName=$selection.text();$inpt.ondata("id",selectionId);$inpt.val(selectionName);if(!$selection.ifclass("highlight")){$selection.onclass("highlight")}return item},suggestionitems:function(){var ac=this,$selectItems=null;if(bzDom(ac.inpt).parent().find(".bz-suggestions").exist()){var $suggestions=bzDom(ac.inpt).parent().find(".bz-suggestions");$selectItems=$suggestions.find("li")}return $selectItems},suggestionscount:function(){var ac=this,itemsLength=0,selectItems=ac.suggestionitems();if(selectItems===null)return;else{if(selectItems.el===null&&selectItems.el===0&&selectItems.el===undefined)return;else if(selectItems!==null&&selectItems.el!==null&&selectItems.el.length>0)itemsLength=selectItems.el.length}return itemsLength},suggestnew:function(){var ac=this;if(ac.mode==="add"||ac.mode==="chip+add"){var itemsLength=ac.suggestionscount();if(itemsLength===0){var $inpt=bzDom(ac.inpt);var params={};if($inpt.ondata("add-params"))params=$inpt.ondata("add-params");var $addBtn=bzDom('<button type="button">');if(ac.o.addBtnClass!=="")$addBtn.onclass(ac.o.addBtnClass);$addBtn.inhtml("Add");$addBtn.on("click",function(){var $that=bzDom(this);var _val=$inpt.val();ac.o.addAction(_val,params,ac);$that.remove()});$inpt.parent(".bz-ac").after($addBtn)}}},hidesuggestnew:function(){var ac=this;var $inpt=bzDom(ac.inpt);if($inpt.parent(".bz-ac-box").find("button").exist()){var $addnew=$inpt.parent(".bz-ac-box").find("button");$addnew.remove()}},addactions:function($inpt){var ac=this;ac.activeIndex=-1;$inpt.on("click",function(){var $that=bzDom(this),_searchstr=$that.val();if(ac.ddlmode==="true"&&ac.listenInput===true){ac.setdata(_searchstr,$that);ac.showSuggestions()}else if(_searchstr.length>0)ac.showSuggestions()});$inpt.on("keyup",function(){var $that=bzDom(this),_searchstr=$that.val();if(_searchstr.length>=ac.o.searchAfter&&ac.listenInput===true){ac.setdata(_searchstr,$that)}});$inpt.on("blur",function(){var $that=bzDom(this);if($that.ondata("hover")==0)ac.hideSuggestions()});$inpt.on("keydown",function(e){var $that=bzDom(this);var item=null,$selectItems=ac.suggestionitems()||null,itemsLength=ac.suggestionscount()||0;if(e.keyCode===40){ac.listenInput=false;e.preventDefault();if(ac.activeIndex===-1){item=$selectItems.el[0];ac.activeIndex=ac.highlightSelection(bzDom(item),0)}else{activeItem=bzDom($selectItems.el[ac.activeIndex]);if(activeItem.ifclass("highlight"))activeItem.offclass("highlight");k=ac.activeIndex;if(k+1===itemsLength){k=0;item=$selectItems.el[k];ac.activeIndex=ac.highlightSelection(bzDom(item),k)}else{k=k+1;item=$selectItems.el[k];ac.activeIndex=ac.highlightSelection(bzDom(item),k)}}}else if(e.keyCode===38){ac.listenInput=false;e.preventDefault();if(ac.activeIndex===-1){item=$selectItems.el[itemsLength-1];ac.activeIndex=ac.highlightSelection(bzDom(item),itemsLength-1)}else{activeItem=bzDom($selectItems.el[ac.activeIndex]);if(activeItem.ifclass("highlight"))activeItem.offclass("highlight");var k=ac.activeIndex;if(k-1===-1){k=itemsLength-1;item=$selectItems.el[k];ac.activeIndex=ac.highlightSelection(bzDom(item),k)}else{k=k-1;item=$selectItems.el[k];ac.activeIndex=ac.highlightSelection(bzDom(item),k)}}}else if(e.keyCode===27){e.preventDefault();var activeItem=bzDom($selectItems.el[ac.activeIndex]);if(activeItem.ifclass("highlight"))activeItem.offclass("highlight");ac.activeIndex=-1;ac.removeSuggestions();ac.listenInput=true;var $inpt=bzDom(ac.inpt);$inpt.ondata("id",null);$inpt.val(ac.srchString);ac.hidesuggestnew()}else if(e.keyCode===13||e.keyCode===9){e.preventDefault();ac.listenInput=false;ac.removeSuggestions();if(ac.activeIndex!==-1&&$selectItems.el[ac.activeIndex]!=="undefined"){var activeItem=bzDom($selectItems.el[ac.activeIndex]),_selectionId=activeItem.ondata("id"),_selectionName=activeItem.text();ac.activeIndex=-1;if(ac.mode==="+chip"||ac.mode==="chip+"||ac.mode==="chip+add"){ac.o.addchip(_selectionId,_selectionName,ac);ac.hidesuggestnew()}else{ac.selection(_selectionId,_selectionName);ac.hidesuggestnew()}}else ac.hidesuggestnew()}else ac.listenInput=true})},init:function(){var ac=this,_input=bzDom(ac.inpt);ac.addactions(_input)}};Autocomplete.defaultOptions={searchAfter:1,dataurl:null,source:function(passdata,url,q,_this){var data=new FormData;data.append("q",q);if(bzDom(_this.inpt).ondata("prop")){var props=bzDom(_this.inpt).ondata("prop");props=props.split(",");for(var j=0;j<props.length;j++){var paramVal=props[j],paramName=paramVal.split(":");data.append(""+paramName[0]+"",paramName[1])}}var xhr=new XMLHttpRequest;try{xhr.abort()}catch(e){}xhr.onreadystatechange=function(){if(this.readyState===4&&this.status===200){passdata(JSON.parse(this.responseText),q,_this)}};xhr.open("POST",url,true);xhr.send(data)},suggest:function(searchstr,suggesteddata,ac){ac.removeSuggestions();ac.addSuggestions();if(suggesteddata.length>0){for(var i=0;i<suggesteddata.length;i++){var $listItem=ac.o.render(suggesteddata[i][1],searchstr,suggesteddata[i][0]);$listItem.on("click",function(){var $that=bzDom(this),_selectionName=$that.ondata("value"),_selectionId=$that.ondata("id");ac.selection(_selectionId,_selectionName);if(ac.mode==="+chip"||ac.mode==="chip+"||ac.mode==="chip+add"){ac.o.addchip(_selectionId,_selectionName,ac)}ac.hidesuggestnew()});ac.fillSuggestions($listItem)}}},render:function(item,searchstr,itemid){searchstr=searchstr.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&");var listitem=bzDom('<li class="bz-padding-8">');listitem.ondata("id",itemid);listitem.ondata("value",item);var re=new RegExp("("+searchstr.split(" ").join("|")+")","gi");item=item.replace(re,"<b class='bz-fc-primary'>$1</b>");listitem.inhtml(item);return listitem},addchip:function(selectionId,selectionName,ac){var $chip=bzDom("<div>");$chip.onclass("bz-chip small");var $img=bzDom("<img>");var $chipName=bzDom("<div>");$chipName.onclass("text");$chipName.inhtml(selectionName);var $chipDel=bzDom("<div>");$chipDel.onclass("chip-close");$chipDel.inhtml("✕");$chipDel.ondata("id",selectionId);$chipDel.on("click",function(){var $that=bzDom(this),_itemid=$that.ondata("id");alert("remove: "+_itemid);$that.parent(".bz-chip").remove()});$chip.append($chipName);$chip.append($chipDel);bzDom(ac.inpt).before($chip);bzDom(ac.inpt).val("")},selAction:function(inpt,selectionId,selectionName,ac){},addBtnClass:"",addAction:function(val,params,ac){alert("Adding action not specified. value: "+val+", params: "+JSON.stringify(params))}};